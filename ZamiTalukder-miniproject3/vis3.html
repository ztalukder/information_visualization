<html>

<head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif
        }
        
        svg{
        	border-style: solid;
        	border-width: 5px;
        }

        .mainView {
        	display: flex;
        }
    </style>
    <script src="d3.js"></script>
</head>

<body>
	<h2>Money Donated From Country to Country for Purposes</h2>
    <div class="mainView">
        <div id="myDiv">
        </div>
    </div>
</body>
<!-- Add this section to your file -->
<script> 
	let store = {};
	function loadData() {
		return Promise.all([
			d3.csv("aiddata.csv"),
		]).then(datasets => {
			store.data = datasets[0];
			return store;
		})
	}
	
	function groupByDonated(data) {
		let result = data.reduce((result, d) => {
			let donator = result[d.coalesced_purpose_name] || {
				"Purpose": d.coalesced_purpose_name,
				"Received": 0
			}
			donator.Received += 1;
			result[d.coalesced_purpose_name] = donator;
			
	
			return result;
		}, {})
		
		result = Object.keys(result).map(key => result[key])
		result = result.sort(function(first,second) { return d3.ascending(second.Received, first.Received); });

		let topFive = result.slice(0,5);
		topFive = Object.values(topFive).map(x=>x["Purpose"]);


		let countries = {};
		let donatorCountries = {};
		let recipientCountries = {};
		for(let i = 0; i < data.length; i++){
			if(topFive.indexOf(data[i].coalesced_purpose_name) != -1 ){
				let country = countries[data[i].donor] || {};
				let recipient = country[data[i].recipient] || {
					"Recipient": data[i].recipient
				}
				recipient[data[i].coalesced_purpose_name] = 1;
				countries[data[i].donor] = country;
				countries[data[i].donor][data[i].recipient] = recipient;


				let donatorCountry = donatorCountries[data[i].donor] || {
					"Country": data[i].donor,
					"Count": 0
				}

				donatorCountry["Count"] += 1;
				donatorCountries[data[i].donor] = donatorCountry;

				let recipientCountry = recipientCountries[data[i].recipient] || {
					"Country": data[i].recipient,
					"Count": 0
				}

				recipientCountry["Count"] += 1;
				recipientCountries[data[i].recipient] = recipientCountry;
			}			
		}

		let keys = Object.keys(countries);
		for(let i = 0; i < keys.length; i++){
			countries[keys[i]] = Object.values(countries[keys[i]]).map(x=>x);
		}

		donatorCountries = Object.values(donatorCountries).map(x=>x)
		donatorCountries = donatorCountries.sort(function(first,second) { return d3.ascending(second.Count, first.Count); });
		donatorCountries = Object.values(donatorCountries).map(x=>x["Country"])

		recipientCountries = Object.values(recipientCountries).map(x=>x)
		recipientCountries = recipientCountries.sort(function(first,second) { return d3.ascending(second.Count, first.Count); });
		recipientCountries = Object.values(recipientCountries).map(x=>x["Country"])

		return {countries, topFive, donatorCountries, recipientCountries}
	}
	
	function showData() {
		let data = store.data
		let groupedResults = groupByDonated(store.data);
		let color = [];
		drawBigGraph(groupedResults.countries, groupedResults.donatorCountries, groupedResults.recipientCountries,  groupedResults.topFive);
	}


	function drawBigGraph(data, donatorCountries, recipientCountries,  topFive) {
		let container = d3.select("#myDiv");
		
		var margin = {
			top: 150,
			right: 350,
			bottom: 150,
			left: 130
		}

		let gridSizeWidth = 30,
			gridSizeHeight = 30,
			countriesX = recipientCountries,
			countriesY = donatorCountries,
			width = gridSizeWidth * countriesX.length + margin.left + margin.right;
			height = gridSizeHeight * countriesY.length + margin.top + margin.bottom;
			
		var svg = container
			.append("svg")
			.attr("width", width)
			.attr("height", height)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
		var y = d3.scaleBand()
			.range([0,height-margin.bottom])
			.domain(countriesY);
			
		var x = d3.scaleBand()
			.range([0,width-margin.right])
			.domain(countriesX);
			
		svg.append("g")
			.call(d3.axisLeft(y));
			
		svg.append("g")
			.call(d3.axisRight(x))
			.attr("transform", "rotate(-90 0 0)");
			
		for(let xAxes in countriesX){
			for(let yAxes in countriesY){
				svg.append("rect")
					.attr("x", x(countriesX[xAxes]))
					.attr("y", y(countriesY[yAxes]))
					.attr("height", gridSizeHeight)
					.attr("width", gridSizeWidth)
					.attr("fill", "#e8f3d2");
			}
		}
			
		let keys = Object.keys(data); 
		for(let i = 0; i < keys.length; i++){
			let recipients = Object.keys(data[keys[i]]);
			for(let j = 0; j < recipients.length; j++){
				let currentData = data[keys[i]][recipients[j]];
				if(topFive[0] in currentData){
					svg.selectAll("circleRed")
						.data(data[keys[i]])
						.enter()
						.append("circle")
						.attr("cx", function(d) { return x(d.Recipient)+gridSizeWidth/2-5})
						.attr("cy", function(d) { return y(keys[i])+gridSizeHeight/2-5})
						.attr("r", 3)
						.style("stroke", "red")
						.attr("fill", "red");
				}

				if(topFive[1] in currentData){
					svg.selectAll("circleBlue")
						.data(data[keys[i]])
						.enter()
						.append("circle")
						.attr("cx", function(d) { return x(d.Recipient)+gridSizeWidth/2+5})
						.attr("cy", function(d) { return y(keys[i])+gridSizeHeight/2-5})
						.attr("r", 3)
						.style("stroke", "blue")
						.attr("fill", "blue");
				}
				if(topFive[2] in currentData){
					svg.selectAll("circleGreen")
						.data(data[keys[i]])
						.enter()
						.append("circle")
						.attr("cx", function(d) { return x(d.Recipient)+gridSizeWidth/2})
						.attr("cy", function(d) { return y(keys[i])+gridSizeHeight/2})
						.attr("r", 3)
						.style("stroke", "green")
						.attr("fill", "green");
				}
				if(topFive[3] in currentData){
					svg.selectAll("circleBrown")
						.data(data[keys[i]])
						.enter()
						.append("circle")
						.attr("cx", function(d) { return x(d.Recipient)+gridSizeWidth/2-5})
						.attr("cy", function(d) { return y(keys[i])+gridSizeHeight/2+5})
						.attr("r", 3)
						.style("stroke", "brown")
						.attr("fill", "brown");
				}
				if(topFive[4] in currentData){
					svg.selectAll("circleBlack")
						.data(data[keys[i]])
						.enter()
						.append("circle")
						.attr("cx", function(d) { return x(d.Recipient)+gridSizeWidth/2+5})
						.attr("cy", function(d) { return y(keys[i])+gridSizeHeight/2+5})
						// .attr("height", gridSizeHeight-15)
						// .attr("width", gridSizeWidth-15)
						.attr("r", 3)
						.style("stroke", "black")
						.attr("fill", "black");
				}

			}
		}

		svg.append("text")             
			.attr("transform", "translate(-100,"+ (height/2 - margin.top) +") rotate(-90 0 0)")
			.style("text-anchor", "middle")
			.text("Money Donator");

		svg.append("text")             
			.attr("transform", "translate("+ (width/2 - margin.left) +", -100)")
			.style("text-anchor", "middle")
			.text("Money Recipient");

		let colors = ["red", "blue", "green", "brown", "black"];
		let offsetsX = [-5, 5, 0, -5, 5]
		let offsetsY = [-5, -5, 0, 5, 5]
		
		let legend = svg.append("g")
            .attr("transform", "translate("+ (width- margin.right+15) + ", 5)");

        legend.selectAll("g").data(topFive)
            .enter()
            .append("g")
            .each(function(d,i) {
                let g = d3.select(this);
                for(let index = 0; index < topFive.length; index++){
                	if(index == i){
                		g.append("circle")
		                    .attr("cx", 0 + offsetsX[i])
		                    .attr("cy", i*30 + offsetsY[i])
		                    .attr("r", 4)
		                    .style("stroke", function(d){
		                        return colors[i];
		                    })
		                    .style("fill", function(d){
		                        return colors[i];
		                    })
		            } else{
	                	g.append("circle")
		                    .attr("cx", 0 + offsetsX[index])
		                    .attr("cy", i*30 + offsetsY[index])
		                    .attr("r", 3)
		                    .style("stroke", "#D3D3D3")
		                    .style("fill", "#D3D3D3")
		            }
                	
                }

                g.append("text")
                    .attr("x", 10)
                    .attr("y", i * 30 + 5)
                    .attr("height",50)
                    .attr("width",50)
                    .text(d);

            });
	}
	
	loadData().then(showData);
	
	
</script>

</html>