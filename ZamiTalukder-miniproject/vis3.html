<html>

<head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif
        }
        
        svg{
        	border-style: solid;
        	border-width: 5px;
        }

        .mainView {
        	display: flex;
        }
    </style>
    <script src="d3.js"></script>
</head>

<body>
	<h2>Amount of Times Money is Received by Continents</h2>
    <div class="mainView">
        <div id="myDiv">
        </div>
    </div>
</body>
<!-- Add this section to your file -->
<script> 
	let store = {};
	let countryToContinent = {
		"Saudi Arabia": "Asia",
		"India": "Asia",
		"Brazil": "South America",
		"Taiwan": "Asia",
		"Korea": "Asia",
		"Kuwait": "Asia",
		"Cyprus": "Europe",
		"Lithuania": "Europe",
		"Thailand": "Asia",
		"Slovak Republic": "Europe",
		"Qatar": "Asia",
		"United States": "North America",
		"South Africa": "Africa",
		"Colombia": "South America",
		"France": "Europe",
		"Chile": "South America",
		"Estonia": "Europe",
		"Poland": "Europe",
		"Czech Republic": "Europe",
		"Hungary": "Europe",
		"Romania": "Europe",
		"Canada": "North America",
		"Australia": "Australia",
		"Sweden": "Europe",
		"Denmark": "Europe",
		"Finland": "Europe",
		"Greece": "Europe",
		"Austria": "Europe",
		"Ireland": "Europe",
		"Japan": "Asia",
		"Luxembourg": "Europe",
		"New Zealand": "Europe",
		"United Kingdom": "Europe",
		"Belgium": "Europe",
		"Norway": "Europe",
		"Italy": "Europe",
		"Portugal": "Europe",
		"Spain": "Europe",
		"Liechtenstein": "Europe",
		"Latvia": "Europe",
		"Iceland": "Europe",
		"Switzerland": "Europe",
		"Germany": "Europe",
		"Slovenia": "Europe",
		"Monaco": "Europe",
		"United Arab Emirates": "Asia",
		"Netherlands": "Europe"
	};

	function loadData() {
		return Promise.all([
			d3.csv("aiddata.csv"),
		]).then(datasets => {
			store.data = datasets[0];
			return store;
		})
	}
	
	function groupByReceived(data) {
		//First, find the most popular purposes
		let result = data.reduce((result, d) => {
			let donator = result[d.coalesced_purpose_name] || {
				"Purpose": d.coalesced_purpose_name,
				"Received": 0
			}
			donator.Received += 1;
			result[d.coalesced_purpose_name] = donator;
			
	
			return result;
		}, {})
		
		//Sort and find the top 5 
		result = Object.keys(result).map(key => result[key])
		result = result.sort(function(first,second) { return d3.ascending(second.Received, first.Received); });

		topFive = [result[0].Purpose, result[1].Purpose, result[2].Purpose, result[3].Purpose, result[4].Purpose]

		//Next, find the amount of times the country received money for that purpose
		let answer = {};
		
		for(let i = 0; i < data.length; i++) {
			if(topFive.indexOf(data[i].coalesced_purpose_name) > -1){
				let original = {}
				for(let i = 0; i < topFive.length; i++){
					original[topFive[i]] = 0;
				}
				original["Country"] = data[i].recipient;

				let recipient = answer[data[i].recipient] || original;

				recipient[data[i].coalesced_purpose_name] += 1;
				answer[data[i].recipient] = recipient;
				
			}
		}
		answer = Object.keys(answer).map(key => answer[key])
		
		//Convert the countries amount to continents amount to group regions
		//A map was created to map countries to continents
		continents = {};
		continentsName = [];
		for(let i = 0; i < answer.length; i++){
			let currentContinent = countryToContinent[answer[i].Country];
			if( currentContinent in continents){
				let myKeys = Object.keys(answer[i]);
				for(let j = 0; j < myKeys.length; j++){
					if(myKeys[j] != "Country"){
						continents[currentContinent][myKeys[j]] += answer[i][myKeys[j]];
					}
				}
			}
			else{
				continents[currentContinent] = {};
				delete answer[i]["Country"];
				continents[currentContinent] = answer[i];
				continentsName.push(currentContinent);
			}
		}
		continents = Object.keys(continents).map(key => continents[key]);
		
		//Finally, find the max of the counts for the y scale
		let max = 0;
		for(let i = 0; i < continents.length; i++){
			let keys = Object.keys(continents[i]);
			for(let j = 0; j < keys.length; j++){
				if (max < continents[i][keys[j]]){
					max = continents[i][keys[j]];
				}
			}
		}
	
		return {continents, continentsName, max};
	}
	
	function showData() {
		//Get the routes from our store variable
		let data = store.data
		// Compute the number of routes per airline.
		let continentsData = groupByReceived(store.data);
		
		let legendInfo = drawChart(continentsData.continents, continentsData.continentsName, continentsData.max);
		makeLegend(legendInfo.svg, legendInfo.keys, legendInfo.colors);
	}
	
	function drawChart(continents, continentsName, max){
		//Make the config
		let container = d3.select("#myDiv")
		let width = 750;
		let height = 400;
		let margin = {
			top: 50,
			bottom: 100,
			left: 130,
			right: 200
		}
		let barPadding = .2;
		let axisTicks = {qty: 10, outerSize: 0};

		var svg = container
			.append("svg")
			.attr("width", width)
			.attr("height", height)
					.append("g")
			.attr("transform", `translate(${margin.left}, ${margin.top})`);

		//create scales and axes
		var xScale0 = d3.scaleBand().range([0, width-margin.left - margin.right]).padding(barPadding);
		
		var xScale1 = d3.scaleBand();
		
		var yScale = d3.scaleLinear().range([height-margin.top-margin.bottom,0]);
		
		var xAxis = d3.axisBottom(xScale0).tickSizeOuter(axisTicks.outerSize);
		var yAxis = d3.axisLeft(yScale).ticks(axisTicks.qty).tickSizeOuter(axisTicks.outerSize);

		//define domain of each axis
		xScale0.domain(continentsName);
		xScale1.domain(Object.keys(continents[0])).range([0, xScale0.bandwidth()])
		
		yScale.domain([0, max])
		
		// add in the bars and their locations and dimensions
		var model = svg.selectAll(".continent")
			.data(continents)
			.enter().append("g")
			.attr("class", "continent")
			.attr("transform", function(d,i) { return "translate(" + xScale0(continentsName[i]) + ",0)"} );
		
		let keys = Object.keys(continents[0]);
		
		//define color of each purpose
		let colors = ["#003f5c", "#ffa600", "#fff18f", "#501b4a", "#3eb9bb"];
		
		
		for(let i = 0; i < keys.length; i++){			
			model.selectAll(".bar")
				.data(d=>[d])
				.enter()
				.append("rect")
			.style("fill", colors[i])
				.attr("x", d=> xScale1(keys[i]))
				.attr("y", d=> yScale(d[keys[i]]))
				.attr("width", xScale1.bandwidth())
				.attr("height", function(d) {return height-margin.top - margin.bottom - yScale(d[keys[i]])});
			
		}
			
		svg.append("g")
			.attr("class", "x axis")
			.attr("transform", `translate(0, ${height-margin.top-margin.bottom})`)
			.call(xAxis)
				.selectAll("text");
		
		svg.append("g")
			.attr("class", "y axis")
			.call(yAxis);
			
		return {svg, keys, colors};
		
		
	}
	
	function makeLegend(svg, keys, colors){
		let legend = svg.append("g")
			.attr("class", "legend")
            .attr("transform", "translate(400, 0)");


		legend.selectAll("g").data(keys)
			.enter()
			.append("g")
			.each(function(d,i) {
				let g = d3.select(this);
				g.append("rect")
					.attr("x", 10)
					.attr("y", i*20)
					.attr("width", 10)
					.attr("height", 10)
					.style("fill", function(d,j){
                        return colors[i];
                    })

				g.append("text")
		        	.attr("x", 30)
		            .attr("y", i * 20 + 10)
		            .attr("height",50)
		            .attr("width",50)
		            .style("fill", "black")
		            .text(d);

			});
	}
	
	loadData().then(showData);
	
	
</script>

</html>